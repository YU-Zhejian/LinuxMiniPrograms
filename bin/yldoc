#!/usr/bin/env bash
# YLDOC V1P6
set -ue
DN="$(readlink -f "$(dirname "${0}")")"
echo -e "\033[33mYuZJLab Documentation System"
echo -e "Copyright (C) 2019-2020 YU Zhejian\033[0m"
. "${DN}"/../lib/libisopt
. "${DN}"/../etc/path.sh
more="${mymore}"
STDS=()
for opt in "${@}"; do
    if isopt "${opt}"; then
        case "${opt}" in
        "-h" | "--help")
            yldoc yldoc
            exit 0
            ;;
        "-v" | "--version")
            echo "Version 1 Patch 6"
            exit 0
            ;;
        --more\:*)
            more="${opt:7}"
            if $("${more}" --help &>/dev/null;echo ${?}) -eq 127; then
                echo -e "\033[31mERROR! Invalid More '${more}'! Will use original '${mymore}' instead.\033[0m"
                more="${mymore}"
            else
                echo -e "\033[33mWill use '${more}' as More.\033[0m"
            fi
            ;;
        "-l" | "--list")
            echo -e "\033[33mReading database...\033[0m"
            "${myls}" -1 "${DN}"/../doc | "${mysort}" | "${mysed}" 's/.usage//' | "${more}"
            exit 0
            ;;
        *)
            echo -e "\033[31mERROR: Option '${opt}' invalid.\033[0m"
            exit 1
            ;;
        esac
    else
        STDS=("${STDS[@]}" "${opt}")
    fi
done
if [ ${#STDS[@]} -eq 0 ]; then
    yldoc yldoc
    exit 0
fi
if [ -f "${DN}"/../etc/yldoc.conf ]; then
    while read line; do
        li=(${line})
        for ((i = 0; i < ${#STDS[@]}; i++)); do
            if [ ${STDS[${i}]} = ${li[0]} ]; then
                STDS[${i}]=${li[1]}
            fi
        done
    done <"${DN}"/../etc/yldoc.conf
fi
for fn in "${STDS[@]}"; do
    if [ -f "${DN}"/../doc/"${fn}".usage ]; then
        "${mycat}" "${DN}"/../doc/"${fn}".usage | "${more}"
    else
        echo -e "\033[31mERROR: ${DN}/../doc/${fn}.usage not found! \033[0m"
        exit 1
    fi
done
