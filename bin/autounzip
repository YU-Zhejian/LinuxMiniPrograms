#!/usr/bin/env bash
# AUTOUNZIP V5
set -eu
ISAOTOZIP=false
PAR=''
SUFF=''
DN="$(readlink -f "$(dirname "${0}")")"
. "${DN}"/exec/libautozip.sh
# ============ Start ============
infoh "YuZJLab AutoUnZip"
infoh "Copyright (C) 2019-2021 YU Zhejian"
for opt in "${OPT[@]}"; do
	case "${opt}" in
	"--force")
		warnh "Will remove the archive if exists"
		ISFORCE=true
		;;
	"--remove")
		warnh "Will remove the original file if success"
		REMOVE=true
		;;
	-p\:*)
		THREAD=${opt:3}
		;;
	--parallel\:*)
		THREAD=${opt:10}
		;;
	"-p" | "--parallel")
		THREAD=${MAXTHREAD}
		;;
	*)
		warnh "Option '${opt}' invalid. Ignored"
		;;
	esac
done
# ============ Possess arguments ============
[ ${#STDS[@]} -gt 0 ] || autozipck
for fulln in "${STDS[@]}"; do
	ISBLANK=false
	fn="$(echo ${fulln%.*} | "${mysed}" "s;.part1$;;" | "${mysed}" "s;.part01$;;")"
	ext="${fulln##*.}"
	if [ "${fn##*.}" = "tar" ]; then
		ext="tar.${ext}"
		fn="${fn%.*}"
	fi
	if [ ! -e "${fulln}" ]; then
		warnh "Filename '${fulln}' invalid"
		continue
	fi
	ckext
	infoh "Received: ${0} ${fulln} ${OPT[*]} ==>Extension=${ext}"
	if [ -e "${fn}" ]; then
		if ${ISFORCE}; then ${myrm} -rf "${fn}"; else ${mymv} -f "${fn}" "${fn}".bak; fi
	fi
	# ============ Start Decompressing ============
	function __do_job() {
		cmd="$(bash ${DN}/exec/azcmd.sh --decompress ${1})"
		infoh "${cmd}"
		[ "${mytar}" != 'ylukh' ] || errh "Tar NO exist"
		"${mycat}" "${fulln}" | ${cmd} | "${mytar}" -xv -f -
	}
	case ${ext} in
	tar.*)
		__do_job "${ext//tar./}"
		;;
	"tar")
		__do_job "tar"
		;;
	t*z)
		__do_job "${ext//t/}"
		;;
	"7z")
		[ "${my7z}" != 'ylukh' ] || errh "p7zip NO exist"
		! [ ${THREAD} -gt 0 ] || PAR="-mmt${THREAD}"
		"${my7z}" -y ${PAR} x "${fulln}"${SUFF}
		;;
	"zip")
		if [ "${my7z}" != 'ylukh' ]; then
			! [ ${THREAD} -gt 0 ] || PAR="-mmt${THREAD}"
			"${my7z}" -y ${PAR} x "${fulln}"
		else
			[ "${myunzip}" != 'ylukh' ] || errh "unzip NO exist"
			"${myunzip}" "${fulln}"
		fi
		;;
	"rar")
		[ "${myunrar}" != 'ylukh' ] || errh "unrar NO exist"
		! [ ${THREAD} -gt 0 ] || PAR="-mt${THREAD}"
		"${myunrar}" ${PAR} x "${fulln}"
		;;
	*)
		cmd="$(bash ${DN}/exec/azcmd.sh --decompress ${ext})"
		fcat "${fulln}" | ${cmd} > "${fn}"
		;;
	esac
	# ============ Finished ============
	infoh "Removing temporary resources..."
	${REMOVE} && "${myrm}" -rf "${fulln}"
done
# ============ Finished ============
infoh "Finished"
exit 0
