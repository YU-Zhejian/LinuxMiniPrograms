#!/usr/bin/env bash
VERSION=1.3
set -ue
DN="$(readlink -f "$(dirname "${0}")")"
. "${DN}"/../lib/libisopt
. "${DN}"/../etc/path.conf
. "${DN}"/../lib/libstr
. "${DN}"/exec/pathutils.sh
infoh "YuZJLab MANPATH ls"
infoh "Copyright (C) 2019-2021 YU Zhejian"
oldifs="${IFS}"

locallib=$(for dir in \
    $(__addpref 'man') \
    $(__addpref 'share/man'); do echo "${dir}"; done | grep -v '*' | tr '\n' ':')

INPATH="$(manpath 2>/dev/null || true):${locallib}:$(cat /usr/local/etc/man.d/*.conf 2>/dev/null | grep -v \# | grep MANPATH | cut -f 2 -d ' ' | tr '\n' ':' || true):${MANPATH:-}"
. "${DN}"/../lib/libpath
IFS=":"
eachpath=(${valid_path})
unset duplicated_path
IFS=''
STDS=()
for opt in "${@}"; do
    if isopt "${opt}"; then
        case "${opt}" in
        "-h" | "--help")
            yldoc manls
            exit 0
            ;;
        "-v" | "--version")
            echo ${VERSION}
            exit 0
            ;;
        "-l" | "--list")
            echo ${valid_path} | tr ':' '\n'
            unset valid_path
            exit 0
            ;;
        "-x")
            set -x
            ;;
        *)
            warnh "Option '${opt}' invalid. Ignored"
            ;;
        esac
    else
        STDS=(${STDS[@]} "${opt}")
    fi
done
unset invalid_path valid_path
tmpf="$(mktemp -t pls.XXXXXX)"
infoh "Reading database..."
for dir in "${eachpath[@]}"; do
    ls -1 -F "${dir}" | sed "s;^;$(echo "${dir}")/;" | grep man[^/]*/$ | while read line; do
        ls -1 -F "${line}" | sed "s;.gz;;" | sed "s;^;$(echo "${line}");" >>"${tmpf}"
    done
done
if [ ${#STDS[@]} -eq 0 ]; then
    cat "${tmpf}"
else
    IFS=''
    grepstr=''
    for fn in "${STDS[@]}"; do
        grepstr="${grepstr} -e ${fn}"
    done
    eval cat \"${tmpf}\"\|grep "${grepstr}"
fi
rm "${tmpf}"
IFS="${oldifs}"
