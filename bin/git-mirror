#!/usr/bin/env bash
VERSION=1.3
DN="$(readlink -f "$(dirname "${0}")")"
set -ue
trap '' SIGINT
OLD_IFS="${IFS}"
touch "${DN}"/../etc/git-mirror.conf
. "${DN}"/../lib/libisopt
. "${DN}"/../lib/libstr
. "${DN}"/../etc/path.conf
. "${DN}"/../etc/git-mirror.conf
. "${DN}"/exec/gitm/libgitm.sh
infoh "YuZJLab Git Mirror Manager"
infoh "Copyright (C) 2020-2021 YU Zhejian"
STDS=()
UKOPT=()
HAVEHELP=false
HAVEVER=false
# ============ Possess arguments ============
for opt in "${@}"; do
	if isopt "${opt}"; then
		case "${opt}" in
		"-x")
			set -x
			;;
		"-h" | "--help")
			HAVEHELP=true
			UKOPT=("${UKOPT[@]}" "${opt}")
			;;
		"-v" | "--version")
			HAVEVER=true
			UKOPT=("${UKOPT[@]}" "${opt}")
			;;
		--home\:*)
			GITM_HOME="${opt:7}"
			;;
		*)
			UKOPT=("${UKOPT[@]}" "${opt}")
		esac
	else
		STDS=("${STDS[@]}" "${opt}")
	fi
done
gmcmd=${STDS[0]:-}
unset STDS[0]
if [ -z "${GITM_HOME:-}" ];then
	warnh "GITM_HOME undefined. Will use ${DN}/../var/git-mirror.d"
	GITM_HOME=${DN}/../var/git-mirror.d
fi
mkdir -p "${GITM_HOME}" "${GITM_HOME}/logs/" "${GITM_HOME}/uuidtable.d/"
cd "${GITM_HOME}"
ls uuidtable.d/* &>> /dev/null || touch uuidtable.d/"$(date '+%Y-%m-%d_%H-%M-%S')"
touch act.log
if [ "${gmcmd}" = "lscmd" ];then
	ls -1 "${DN}"/exec/gitm/ | grep -v lib | sed 's;\.sh$;;'
elif [ -f "${DN}"/exec/gitm/"${gmcmd}".sh ]; then
	. "${DN}"/exec/gitm/"${gmcmd}".sh
elif [ -f "${DN}"/exec/gitm/"${gmcmd}".py ]; then
	IFS="${OLD_IFS}"
	if [ "${mypython}" != "ylukh" ]; then
		"${mypython}" "${DN}"/exec/gitm/"${sjscmd}".py "${PWD}" "${@}"
	else
		errh "Python not found"
	fi
elif [ -z "${gmcmd}" ];then
	${HAVEHELP} && yldoc git-mirror
	${HAVEVER} && echo "${VERSION}"
else
	IFS="${OLD_IFS}"
	errh "subcommand '${gmcmd}' invalid. Use '${0} lscmd' to get a list of available commands"
fi
IFS="${OLD_IFS}"
