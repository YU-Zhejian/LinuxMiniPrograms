#!/usr/bin/env bash
# LIVECHAT V1EP7
set -ue
DN="$(readlink -f "$(dirname "${0}")")"
. "${DN}"/../etc/path.sh
. "${DN}"/../lib/libstr
function sdmess() {
	echo "$(date +%Y-%m-%d,%H:%M:%S);${1};${MESS_SD}" >>MESSAGES
}
function F_REC() {
	while true; do
	#echo a
		IFS=""
		sleep 1
		local arr=$(wc -l MESSAGES | awk '{print $1}')
		local en=$((${arr} - ${M_R}))
		if [ ${en} -ne 0 ]; then
			echo -ne "\007"
			"${mytail}" -n $((${arr} - ${M_R})) MESSAGES >"URM_${LCUN}"
			local M_R=${arr}
			IFS=";"
			while read line; do
				local M_A=(${line})
				echo -e "\033[31m[${M_A[0]}]\033[0m \033[36m[${M_A[1]}]\033[0m ${M_A[2]}"
			done <"URM_${LCUN}"
		fi
	done
}
OLD_IFS="${IFS}"
LVCD="${DN}/../var/livechat.d"
mkdir -p "${LVCD}"
if [ ! -e "${LVCD}"/LCONLINE ]; then
	warnh "livechat.d/LCONLINE not exist"
	touch "${LVCD}"/LCONLINE
fi
cd "${LVCD}"
unset LVCD
infoh "Welcome to YuZJLab LiveChat"
infoh "Copyright (C) 2019-2020 YU Zhejian"
. "${DN}"/../lib/libisopt
STDS=""
for opt in "${@}"; do
	if isopt ${opt}; then
		case ${opt} in
		"-h" | "--help")
			yldoc livechat
			exit 0
			;;
		"-v" | "--version")
			echo "Version 1 Emergency Patch 7"
			exit 0
			;;
		*)
			errh "Option '${opt}' invalid"
			;;
		esac
	else
		STDS="${opt}"
	fi
done

if [ -z "${STDS}" ]; then
	infoh "Please key in your name/roomnumber:"
	infoh "Use Ctrl-C to exit"
	read LCUN
else
	LCUN="${STDS}"
fi
while read line;do
	if [ "${line}" = "${LCUN}" ];then
	errh "There's a user with the same name"
	exit 1
	fi
done < LCONLINE
unset BOOLONLINE
echo "${LCUN}" >>LCONLINE
MESS_SD="${LCUN} is now on line"
sdmess SYSTEM
infoh "The following users are now online:"
cat LCONLINE
infoh "Please use 'logout' instead of Ctrl-C to exit"
export M_R=0
(F_REC) &
pid_rec=${!}
infoh "PID of reciever: ${pid_rec}"
while true; do
	read MESS_SD
	if [ "${MESS_SD}" != "logout" ]; then
		sdmess "${LCUN}"
		printf "\033[1A"
	else
		MESS_SD="${LCUN} had quitted"
		sdmess "SYSTEM"
		kill -9 ${pid_rec} &>>/dev/null
		"${mycat}" LCONLINE |"${mygrep}" -v "^${LCUN}$" >tmp
		"${mymv}" tmp LCONLINE
		"${myrm}" "URM_${LCUN}"
		infoh "Thanks for using this system"
		IFS="${OLD_IFS}"
		exit 0
	fi
done
