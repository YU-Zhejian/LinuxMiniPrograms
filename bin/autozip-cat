#!/usr/bin/env bash
# AUTOZIP-CAT V4
# ============ Functions ============
set -eu
DN="$(readlink -f "$(dirname "${0}")")"
ISAUTOZIP=false
ISCAT=true
. "${DN}"/exec/libautozip.sh
# ============ Start ============
ppopt "${@}"
fn="${STDS[0]:-}"
! [ -z "${fn}" ] || fn="-"
if [ "${fn}" != "-" ] && [ ! -e "${fn}" ]; then
	exit 1
fi
ext="${STDS[1]:-}"
! [ -z "${ext}" ] || ext="gz"
LVL="${STDS[2]:-}"
# ============ Start Compressing ============
case ${ext} in
"txt")
	cmd="${mycat}"
	;;
"gz" | "GZ")
	if [ "${mypigz}" != 'ylukh' ]; then
		cklvl pigz
		cmd="${mypigz} -cvf ${LVL} -p ${THREAD}"
	elif [ "${mygzip}" != 'ylukh' ]; then
		cklvl gz
		cmd="${PAR} ${mygzip} -cvf ${LVL}"
	elif [ "${my7za}" != 'ylukh' ]; then
		cklvl 7z
		cmd="${my7za} a -aoa -si -so -y stdin -mmt=${THREAD} ${LVL} -tgzip"
	fi
	;;
"xz")
	if [ "${myxz}" != 'ylukh' ]; then
		cklvl xz
		cmd="${myxz} -cvvf --threads=${THREAD} ${LVL} -"
	elif [ "${my7za}" != 'ylukh' ]; then
		cklvl 7z
		cmd="${my7za} a -aoa -si -so -y ${fn} -mmt=${THREAD} ${LVL} -txz"
	fi
	;;
"bz2")
	if [ "${mybzip2}" != 'ylukh' ]; then
		cklvl bzip2
		cmd="${PAR} ${mybzip2} -cvf ${LVL}"
	elif [ "${my7za}" != 'ylukh' ]; then
		cklvl 7z
		cmd="${my7za} a -aoa -si -so -y ${fn} -mmt=${THREAD} ${LVL} -tbzip2"
	fi
	;;
"lzma")
	[ ${THREAD} -gt 1 ] && warnh "${1} do not support parallel. Thread will be resetted to 1"
	if [ "${myxz}" != 'ylukh' ]; then
		cklvl xz
		cmd="${myxz} -fcvv --format=lzma ${LVL} -"
	elif [ "${mylzma}" != 'ylukh' ]; then
		cklvl xz
		cmd="${mylzma} -cvf ${LVL} -"
	fi
	;;
"lz4")
	[ "${mylz4}" != 'ylukh' ] || errh "NO valid lz4 exist"
	cklvl lz4
	cmd="${PAR} ${mylz4} -cvvf ${LVL} -"
	;;
"zst")
	[ "${myzstd}" != 'ylukh' ] || errh "NO valid zstd exist"
	cklvl zst
	cmd="${myzstd} -cvvvf ${LVL} -T${THREAD} -"
	;;
"lzo")
	[ "${mylzop}" != 'ylukh' ] || errh "NO valid lzop exist"
	cklvl lzop
	cmd="${PAR} ${mylzop} -cvf ${LVL} -"
	;;
"br")
	[ "${mybrotli}" != 'ylukh' ] || errh "NO valid brotli exist"
	cklvl br
	cmd="${mybrotli} -cvf ${LVL} -"
	;;
"Z" | "z")
	[ "${mycompress}" != 'ylukh' ] || errh "NO valid compress exist"
	cklvl z
	cmd="${mycompress} -cvf -"
	;;
"lzfse")
	[ "${mylzfse}" != 'ylukh' ] || errh "NO valid lzfse exist"
	cklvl lzfse
	cmd="${mylzfse} -encode"
	;;
"tar.lz" | "lz")
	[ "${mylzip}" != 'ylukh' ] || errh "NO valid lzip exist"
	cklvl lzip
	cmd="${mylzip} -cvvf ${LVL} -"
	;;
"bgz")
	[ "${mybgzip}" != 'ylukh' ] || errh "BGZip NO exist"
	cklvl bgz
	cmd="${mybgzip} -fc -@ ${THREAD} ${LVL}"
	;;
"7z")
	if [ "${my7za}" != 'ylukh' ]; then
		cklvl 7z
		cmd="${my7za} a -aoa -si -so -y ${fn} -mmt=${THREAD} ${LVL} -t7z"
	fi
	;;
"zip")
	if [ "${my7za}" != 'ylukh' ]; then
		cklvl 7z
		cmd="${my7za} a -aoa -si -so -y ${fn} -mmt=${THREAD} ${LVL} -tzip"
	elif [ "${myzip}" != 'ylukh' ]; then
		cklvl zip
		cmd="${myzip} --verbose --split-verbose ${LVL}"
	fi
	;;
*)
	exit 1
	;;
esac
if [ ${fn} = '-' ]; then
	${cmd}
else
	fcat "${fn}" | ${cmd}
fi
