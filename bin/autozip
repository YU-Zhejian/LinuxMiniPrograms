#!/usr/bin/env bash
# AUTOZIP V4
# ============ Functions ============
set -eu
DN="$(readlink -f "$(dirname "${0}")")"
ISAUTOZIP=true
ISCAT=false
. "${DN}"/exec/libautozip.sh
# ============ Start ============
infoh "YuZJLab AutoZip"
infoh "Copyright (C) 2019-2020 YU Zhejian"
ppopt "${@}"
fn="${STDS[0]:-}"
! [ -z "${fn}" ] || autozipck
if [ -z "${STDS[1]:-}" ]; then
	if [ -f "${fn}" ]; then
		ext="gz"
	elif [ -d "${fn}" ]; then
		fn=$(echo ${fn} | ${mysed} "s;/$;;")
		ext="tar.gz"
	else
		errh "Filename '${fn}' invalid"
	fi
else
	ext=${STDS[1]}
	ckext
	if [ -d "${fn}" ]; then
		fn=$(echo "${fn}" | "${mysed}" 's;/$;;')
		case "${ext}" in
		t* | "rar" | "zip" | "7z") ;;
		*)
			errh "You're about to compress FOLDER '${fn}' with extension '${ext}', which is designed for compressing SINGLE FILE"
			;;
		esac
	elif [ -f "${fn}" ]; then
		case "${ext}" in
		"gz" | "bgz" | "GZ" | "xz" | "bz2" | "lzma" | "lz" | "rar" | "zip" | "7z" | "lz4" | "lzo" | "zst" | "br" | "z" | "Z" | "lzfse") ;;
		*)
			errh "You're about to compress FILE '${fn}' with extension '${ext}', which is designed for compressing FOLDERs"
			;;
		esac
		[ "${mytar}" != 'ylukh' ] || errh "Tar NO exist"
	else
		errh "Filename '${fn}' invalid"
	fi
fi
unset VALIDSPLIT
LVL="${STDS[2]:-}"
if ${ISFORCE}; then
	if [ -n "${SPLIT:-}" ]; then
		if { "${myls}" "${fn}".part[0-9][0-9].rar &>>/dev/null || ls "${fn}".part[0-9].rar &>>/dev/null; } && [ ${ext} = "rar" ]; then
			"${myrm}" -rf "${fn}".part[0-9].rar "${fn}".part[0-9][0-9].rar
		elif "${myls}" "${fn}".z[0-9][0-9] &>>/dev/null && [ ${ext} = "zip" ]; then
			"${myrm}" -rf "${fn}".z[0-9][0-9] ${fn}.zip
		elif "${myls}" "${fn}".${ext}.[0-9][0-9][0-9] &>>/dev/null; then
			"${myrm}" -rf "${fn}".${ext}.[0-9][0-9][0-9]
		fi
	fi
	[ ! -f "${fn}.${ext}" ] || "${myrm}" -rf "${fn}.${ext}"
else
	if [ -n "${SPLIT:-}" ]; then
		if "${myls}" "${fn}".part[0-9][0-9].rar &>>/dev/null && [ ${ext} = "rar" ]; then
			for tfn in "${fn}".part[0-9][0-9].rar; do
				"${mymv}" -f "${tfn}" "${tfn}".bak
			done
		elif "${myls}" "${fn}".part[0-9].rar &>>/dev/null && [ ${ext} = "rar" ]; then
			for tfn in "${fn}".part[0-9].rar; do
				"${mymv}" -f "${tfn}" "${tfn}".bak
			done
		elif "${myls}" "${fn}".z[0-9][0-9] &>>/dev/null && [ ${ext} = 'zip' ]; then
			for tfn in "${fn}".z[0-9][0-9]; do
				"${mymv}" -f "${tfn}" "${tfn}".bak
			done
			"${mymv}" -f "${fn}".zip "${fn}".zip.bak || true
		elif [ -f "${fn}".${ext}.001 ]; then
			for tfn in "${fn}".${ext}.[0-9][0-9][0-9]; do
				"${mymv}" -f "${tfn}" "${tfn}".bak
			done
		fi
		unset tfn
	fi
	[ ! -f "${fn}.${ext}" ] || "${mymv}" -f "${fn}.${ext}" "${fn}.${ext}".bak
fi
# ============ Start Compressing ============
SPL=''
function do_job() {
	if [ -n "${SPLIT:-}" ]; then
		stdac ${cmd}
	else
		fcat "${fn}" | ${cmd} >"${fn}".${ext}
	fi
}
case ${ext} in
"tar")
	cmd="${mycat}"
	cklvl tar
	do_job
	;;
"tar.gz" | "tgz" | "tar.GZ" | "gz" | "GZ")
	if [ "${mypigz}" != 'ylukh' ]; then
		cklvl pigz
		cmd="${mypigz} -cvf ${LVL} -p ${THREAD}"
	elif [ "${mygzip}" != 'ylukh' ]; then
		cklvl gz
		cmd="${PAR} ${mygzip} -cvf ${LVL}"
	elif [ "${my7za}" != 'ylukh' ]; then
		warnh "Will use 7za to create gzip. Algorithm Deflate instead of LZ77 will be used"
		cklvl 7z
		cmd="${my7za} a -aoa -si -so -y ${fn} -mmt=${THREAD} ${LVL} -tgzip"
	else
		errh "No valid gzip/pigz/7zip exist"
	fi
	do_job
	;;
"tar.xz" | "txz" | "xz")
	if [ "${myxz}" != 'ylukh' ]; then
		cklvl xz
		cmd="${myxz} -cvvf --threads=${THREAD} ${LVL} -"
	elif [ "${my7za}" != 'ylukh' ]; then
		cklvl 7z
		cmd="${my7za} a -aoa -si -so -y ${fn} -mmt=${THREAD} ${LVL} -txz"
	else
		errh "No valid xz/7zip exist"
	fi
	do_job
	;;
"tar.bz2" | "tbz" | "bz2")
	if [ "${mybzip2}" != 'ylukh' ]; then
		cklvl bzip2
		cmd="${PAR} ${mybzip2} -cvf ${LVL}"
	elif [ "${my7za}" != 'ylukh' ]; then
		cklvl 7z
		cmd="${my7za} a -aoa -si -so -y ${fn} -mmt=${THREAD} ${LVL} -tbzip2"
	else
		errh "No valid bzip2/7zip exist"
	fi
	do_job
	;;
"tar.lzma" | "lzma")
	[ ${THREAD} -gt 1 ] && warnh "${1} do not support parallel. Thread will be resetted to 1"
	if [ "${myxz}" != 'ylukh' ]; then
		cklvl xz
		cmd="${myxz} -fcvv --format=lzma ${LVL} -"
	elif [ "${mylzma}" != 'ylukh' ]; then
		cklvl xz
		cmd="${mylzma} -cvf ${LVL} -"
	else
		errh "No valid xz/lzma exist"
	fi
	do_job
	;;
"tar.lz4" | "lz4")
	[ "${mylz4}" != 'ylukh' ] || errh "NO valid lz4 exist"
	cklvl lz4
	cmd="${PAR} ${mylz4} -cvvf ${LVL} -"
	do_job
	;;
"tar.zst" | "zst")
	[ "${myzstd}" != 'ylukh' ] || errh "NO valid zstd exist"
	cklvl zst
	cmd="${myzstd} -cvvvf ${LVL} -T${THREAD} -"
	do_job
	;;
"tar.lzo" | "lzo")
	[ "${mylzop}" != 'ylukh' ] || errh "NO valid lzop exist"
	cklvl lzop
	cmd="${PAR} ${mylzop} -cvf ${LVL} -"
	do_job
	;;
"tar.br" | "br")
	[ "${mybrotli}" != 'ylukh' ] || errh "NO valid brotli exist"
	cklvl br
	cmd="${mybrotli} -cvf ${LVL} -"
	do_job
	;;
"tar.Z" | "tar.z" | "Z" | "z")
	[ "${mycompress}" != 'ylukh' ] || errh "NO valid compress exist"
	cklvl z
	cmd="${mycompress} -cvf -"
	do_job
	;;
"tar.lzfse" | "lzfse")
	[ "${mylzfse}" != 'ylukh' ] || errh "NO valid lzfse exist"
	cklvl lzfse
	cmd="${mylzfse} -encode"
	do_job
	;;
"tar.lz" | "lz")
	[ "${mylzip}" != 'ylukh' ] || errh "NO valid lzip exist"
	cklvl lzip
	cmd="${PAR} ${mylzip} -cvvf ${LVL} -"
	do_job
	;;
"bgz")
	[ "${mybgzip}" != 'ylukh' ] || errh "BGZip NO exist"
	cklvl bgz
	"${mycat}" "${fn}" | "${mybgzip}" -fc -@ ${THREAD} ${LVL} >"${fn}".gz
	;;
"tar.7z")
	if [ "${my7za}" != 'ylukh' ]; then
		cklvl 7z
		cmd="${my7za} a -aoa -si -so -y ${fn} -mmt=${THREAD} ${LVL} -t7z"
	else
		errh "No valid 7zip exist"
	fi
	do_job
	;;
"7z")
	[ "${my7z}" != 'ylukh' ] || errh "p7zip NO exist"
	cklvl 7z
	! [ -n "${SPLIT:-}" ] || SPL="-v${SPLIT}"
	"${my7za}" a -aoa -y "${fn}".${ext} "${fn}" -mmt=${THREAD} ${LVL} -t7z
	;;
"tar.zip")
	if [ "${my7za}" != 'ylukh' ]; then
		cklvl 7z
		cmd="${my7za} a -aoa -si -so -y ${fn} -mmt=${THREAD} ${LVL} -tzip"
	elif [ "${myzip}" != 'ylukh' ]; then
		cklvl zip
		cmd="${myzip} --verbose --split-verbose ${LVL}"
	else
		errh "No valid zip/7zip exist"
	fi
	do_job
	;;
"zip")
	if [ "${my7za}" != 'ylukh' ]; then
		cklvl 7z
		[ -z "${SPLIT:-}" ] || SPL="-v${SPLIT}"
		"${my7za}" a -aoa -y "${fn}".${ext} "${fn}" -mmt=${THREAD} ${LVL} -tzip
	elif [ "${myzip}" != 'ylukh' ]; then
		cklvl zip
		[ -z "${SPLIT:-}" ] || SPL="-s ${SPLIT}"
		"${myzip}" --verbose --split-verbose ${SPL} -r "${fn}".${ext} "${fn}" ${LVL}
	else
		errh "No valid zip/7zip exist"
	fi
	;;
"rar")
	[ "${myrar}" != 'ylukh' ] || errh "rar NO exist"
	! [ -n "${SPLIT:-}" ] || SPL="-v${SPLIT}"
	"${myrar}" -mt${THREAD} ${SPL} a "${fn}".${ext} "${fn}"
	;;
esac
# ============ Finished ============
infoh "Removing temporary resources..."
[ -z "${SPLIT:-}" ] || "${myrm}" -rf "${tempdir}" "${tempf}"
! ${REMOVE} || "${myrm}" -rf ${fn}
