#!/usr/bin/env bash
# AUTOZIP V5
# ============ Functions ============
set -eu
DN="$(readlink -f "$(dirname "${0}")")"
ISAUTOZIP=true
. "${DN}"/exec/libautozip.sh
# ============ Start ============
infoh "YuZJLab AutoZip"
infoh "Copyright (C) 2019-2020 YU Zhejian"
for opt in "${OPT[@]}"; do
	case "${opt}" in
	"--force")
		warnh "Will remove the archive if exists"
		ISFORCE=true
		;;
	"--remove")
		warnh "Will remove the original file if success"
		REMOVE=true
		;;
	-p\:*)
		THREAD=${opt:3}
		;;
	--parallel\:*)
		THREAD=${opt:10}
		;;
	"-p" | "--parallel")
		THREAD=${MAXTHREAD}
		;;
	*)
		warnh "Option '${opt}' invalid. Ignored"
		;;
	esac
done
! ${ISFORCE} && warnh "Will rename the archive if exists"
fn="${STDS[0]:-}"
! [ -z "${fn}" ] || autozipck
if [ -z "${STDS[1]:-}" ]; then
	if [ -f "${fn}" ]; then
		ext="gz"
	elif [ -d "${fn}" ]; then
		fn=$(echo ${fn} | ${mysed} "s;/$;;")
		ext="tar"
	else
		errh "Filename '${fn}' invalid"
	fi
else
	ext=${STDS[1]}
	ckext
	if [ -d "${fn}" ]; then
		fn=$(echo "${fn}" | "${mysed}" 's;/$;;')
		case "${ext}" in
		t* | "rar" | "zip" | "7z") ;;
		*)
			errh "You're about to compress FOLDER '${fn}' with extension '${ext}', which is designed for compressing SINGLE FILE"
			;;
		esac
	elif [ -f "${fn}" ]; then
		case "${ext}" in
		"gz" | "bgz" | "GZ" | "xz" | "bz2" | "lzma" | "lz" | "rar" | "zip" | "7z" | "lz4" | "lzo" | "zst" | "br" | "z" | "Z" | "lzfse") ;;
		*)
			errh "You're about to compress FILE '${fn}' with extension '${ext}', which is designed for compressing FOLDERs"
			;;
		esac
		[ "${mytar}" != 'ylukh' ] || errh "Tar NO exist"
	else
		errh "Filename '${fn}' invalid"
	fi
fi
LVL="${STDS[2]:-}"
if ${ISFORCE}; then
	[ ! -f "${fn}.${ext}" ] || "${myrm}" -rf "${fn}.${ext}"
else
	[ ! -f "${fn}.${ext}" ] || "${mymv}" -f "${fn}.${ext}" "${fn}.${ext}".bak
fi
SPL=''
# ============ Start Compressing ============
function do_job() {
	infoh "${cmd}"
	cmd="$(${DN}/exec/azcmd.sh -p:${THREAD} ${1} ${LVL})"
	fcat "${fn}" | ${cmd} > "${fn}"."${ext}"
}
azcmd.sh="${DN}/exec/azcmd.sh -p:${THREAD}"
case ${ext} in
"bgz")
	ext="gz"
	do_job "bgz"
	;;
"7z")
	[ "${my7z}" != 'ylukh' ] || errh "p7zip NO exist"
	cklvl 7z
	"${my7za}" a -aoa -y "${fn}".${ext} "${fn}" -mmt=${THREAD} ${LVL} -t7z
	;;
"zip")
	if [ "${my7za}" != 'ylukh' ]; then
		cklvl 7z
		"${my7za}" a -aoa -y "${fn}".${ext} "${fn}" -mmt=${THREAD} ${LVL} -tzip
	elif [ "${myzip}" != 'ylukh' ]; then
		cklvl zip
		"${myzip}" --verbose ${SPL} -r "${fn}".${ext} "${fn}" ${LVL}
	else
		errh "No valid zip/7zip exist"
	fi
	;;
"rar")
	[ "${myrar}" != 'ylukh' ] || errh "rar NO exist"
	"${myrar}" -mt${THREAD} ${SPL} a "${fn}".${ext} "${fn}"
	;;
*)
	${DN}/exec/azcat -p:${THREAD} ${fn} ${ext} ${LVL} > "${fn}.${ext}"
	;;
esac
# ============ Finished ============
infoh "Removing temporary resources..."
! ${REMOVE} || "${myrm}" -rf ${fn}
