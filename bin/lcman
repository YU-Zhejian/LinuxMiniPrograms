#!/usr/bin/env bash
# LCMAN V3EP5
set -ue
DN="$(readlink -f "$(dirname "${0}")")"
. "${DN}"/../etc/path.sh
. "${DN}"/../lib/libisopt
. "${DN}"/../lib/libstr
infoh "YuZJLab LiveChat Manager"
infoh "Copyright (C) 2019-2020 YU Zhejian"
LVCD="${DN}/../var/livechat.d"
[ -e "${LVCD}"/MESSAGES ] || errh "livechat.d/MESSAGES not exist"
OLD_IFS="${IFS}"
IFS=";"
tmpfff="$(mktemp -t lcman.XXXXXX)"
STDS=()
sf=()
sm=()
se=()
for opt in "${@}"; do
	if isopt "${opt}"; then
		case "${opt}" in
		"-v" | "--version")
			infoh "Version 3 Emergency Patch 5, compatible with LiveChat Version 1 & 2"
			exit 0
			;;
		"-h" | "--help")
			yldoc lcman
			exit 0
			;;

		-f\:*)
			sf=(${sf[@]} ${opt:3})
			;;
		-m\:*)
			sm=(${sm[@]} ${opt:3})
			;;
		--from\:*)
			sf=(${sf[@]} ${opt:7})
			;;
		--message\:*)
			sm=(${sm[@]} ${opt:10})
			;;
		-e\:*)
			se=(${se[@]} ${opt:3})
			;;
		--exclude\:*)
			se=(${se[@]} ${opt:10})
			;;
		"-s" | "--exclude-system")
			se=(${se[@]} "SYSTEM")
			;;
		*)
			warnh "Option '${opt}' invalid. Ignored"
			;;
		esac
	else
		STDS=("${STDS[@]}" "${opt}")
	fi
done
infoh "Reading Databases..."
i=0
while read line; do
	msg_tmp=(${line})
	f[${i}]="${msg_tmp[1]}"
	m[${i}]="${msg_tmp[2]}"
	uf[${i}]=false
	um[${i}]=false
	unset msg_tmp
	i=$(($i + 1))
done < "${LVCD}"/MESSAGES
infoh "Filtering..."
if [ ${#sf[@]} -eq 0 ]; then
	for ((n = 0; n <= i; n++)); do
		uf[${n}]=true
	done
else
	for item in "${sf[@]}"; do
		for ((n = 0; n <= i - 1; n++)); do
			! [[ ${f[${n}]} == *"${item}"* ]] || uf[${n}]=true
		done
	done
fi
if ! [ ${#se[@]} -eq 0 ]; then
	for item in "${se[@]}"; do
		for ((n = 0; n <= i - 1; n++)); do
			! [ ${f[${n}]} = ${item} ] || uf[${n}]=false
		done
	done
fi
if [ ${#sm[@]} -eq 0 ]; then
	for ((n = 0; n <= i; n++)); do
		um[${n}]=true
	done
else
	for item in "${sm[@]}"; do
		for ((n = 0; n <= i - 1; n++)); do
			! [[ ${m[${n}]} == *"${item}"* ]] || um[${n}]=true
		done
	done
fi
n=0
while read line; do
	if ${uf[${n}]} && ${um[${n}]}; then
		msg_tmp=(${line})
		echo -e "\033[31m[${msg_tmp[0]}]\033[0m \033[36m[${msg_tmp[1]}]\033[0m ${msg_tmp[2]}" >> "${tmpfff}"
	fi
	n=$((n + 1))
done < ${LVCD}/MESSAGES
"${mycat}" "${tmpfff}" | "${mysort}"
IFS=${OLD_IFS}
exit 0
