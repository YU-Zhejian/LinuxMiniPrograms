#!/usr/bin/env bash
# AZLIST V5
set -eu
ISAOTOZIP=false
USESPLIT=false
PAR=''
SUFF=''
DN="$(readlink -f "$(dirname "${0}")")"
. "${DN}"/exec/libautozip.sh
# ============ Start ============
infoh "YuZJLab AutoUnZip"
infoh "Copyright (C) 2019-2020 YU Zhejian"
for opt in "${OPT[@]}"; do
	case "${opt}" in
	-p\:*)
		THREAD=${opt:3}
		;;
	--parallel\:*)
		THREAD=${opt:10}
		;;
	"-p" | "--parallel")
		THREAD=${MAXTHREAD}
		;;
	*)
		warnh "Option '${opt}' invalid. Ignored"
		;;
	esac
done
# ============ Possess arguments ============
[ ${#STDS[@]} -gt 0 ] || errh "Need more than ONE argument"
for fulln in "${STDS[@]}"; do
	ISBLANK=false
	fn="$(echo ${fulln%.*} | "${mysed}" "s;.part1$;;" | "${mysed}" "s;.part01$;;")"
	ext="${fulln##*.}"
	if [ "${fn##*.}" = "tar" ]; then
		ext="tar.${ext}"
		fn="${fn%.*}"
	fi
	if [ -z "${fulln}" ]; then
		autozipck
	elif ! [ -f "${fulln}" ] && [ -f "${fulln}.001" ]; then
		USESPLIT=true
	elif ! [ -f "${fulln}" ] && [ -f "$(echo ${fulln} | "${mysed}" "s;.rar$;.part01.rar;")" ] && [ ${ext} = "rar" ]; then
		fulln="$(echo ${fulln} | "${mysed}" "s;.rar$;.part01.rar;")"
		USESPLIT=true
	elif ! [ -f "${fulln}" ] && [ -f "$(echo ${fulln} | "${mysed}" "s;.rar$;.part1.rar;")" ] && [ ${ext} = "rar" ]; then
		fulln="$(echo ${fulln} | "${mysed}" "s;.rar$;.part1.rar;")"
		USESPLIT=true
	elif ! [ -f "${fulln}" ]; then
		warnh "Filename '${fulln}' invalid"
		continue
	fi
	! ${USESPLIT} || mktmp
	ckext
	infoh "Received: ${0} ${fulln} ${OPT[*]} ==>Extension=${ext}"
	# ============ Start Decompressing ============
	function do_job() {
		cmd="$(${DN}/exec/azcmd --decompress ${1})"
		infoh "${cmd}"
		[ "${mytar}" != 'ylukh' ] || errh "Tar NO exist"
		if ${USESPLIT}; then
			stdtl ${cmd}
		else
			fcat "${fulln}" | ${cmd} | "${mytar}" -tv -f -
		fi
	}
	case ${ext} in
	tar.*)
		do_job "${ext//tar./}"
		;;
	"tar")
		do_job "tar"
		;;
	t*z)
		do_job "${ext//t/}"
		;;
	"7z")
		[ "${my7z}" != 'ylukh' ] || errh "p7zip NO exist"
		if [ ! -f "${fulln}" ] && [ -f "${fulln}.001" ]; then
			fulln="${fulln}.001"
		fi
		"${my7z}" l "${fulln}"
		;;
	"zip")
		[ "${myunzip}" != 'ylukh' ] || errh "unzip NO exist"
		if [ -f "${fn}".z01 ]; then
			[ "${myzip}" != 'ylukh' ] || errh "zip NO exist"
			mktmp
			"${mycp}" "${fn}".z* "${tempdir}"/
			"${myzip}" -FF "${tempdir}"/"${fn}".zip --out "${tempdir}"/"${fn}".fzip
			"${myunzip}" -v "${tempdir}"/"${fn}".fzip
		else
			"${myunzip}" -v "${fulln}"
		fi
		;;
	"rar")
		[ "${myunrar}" != 'ylukh' ] || errh "unrar NO exist"
		"${myunrar}" v "${fulln}"
		;;
	*)
		cmd="$("${DN}"/exec/azcmd --list ${ext})"
		infoh "${cmd}"
		if ${USESPLIT}; then
			stdfx ${cmd}
		else
			fcat "${fulln}" | ${cmd} > "${fn}"
		fi
		;;
	esac
	# ============ Finished ============
	infoh "Removing temporary resources..."
	! ${USESPLIT} || "${myrm}" -rf "${tempdir}" "${tempf}"
done
# ============ Finished ============
infoh "Finished"
exit 0
